box: ubuntu
build:
  steps:
    - script:
        name: initialize
        code: |
          export DEBIAN_FRONTEND=noninteractive
          apt-get update
          apt-get install -y python-pip libffi-dev libssl-dev
          pip install azure-cli
          mkdir output
    - script:
        name: parepare webapp 
        code: |
          tar zcf output/webapp.tar.gz --exclude=.gitignore webapp
    - script:
        name: parepare ansible 
        code: |
          sed -i \
            -e "s:@AZURE_STORAGE_ACCOUNT@:$AZURE_STORAGE_ACCOUNT:g" \
            -e "s:@CONTAINER_NAME@:$WERCKER_GIT_COMMIT:g" \
            ansible/playbook/roles/app/tasks//main.yml
          tar zcf output/ansible.tar.gz ansible
    - script:
        name: prepare azure template
        code: |
          sed \
            -e "s:@AZURE_STORAGE_ACCOUNT@:$AZURE_STORAGE_ACCOUNT:g" \
            -e "s:@CONTAINER_NAME@:$WERCKER_GIT_COMMIT:g" \
            azure/azuredeploy.json > output/azuredeploy.json
    - script:
        name: upload blob
        code: |
          az storage container create --public-access blob --name "$WERCKER_GIT_COMMIT"
          cd output
          for file in * ; do
              az storage blob upload --file $file --container-name "$WERCKER_GIT_COMMIT" --name $file
          done
